# Namespace + PVC (Immich chart won't create the library PVC for you)
apiVersion: v1
kind: Namespace
metadata:
  name: immich
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: immich-library
  namespace: immich
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 50Gi
  storageClassName: nfs
---
# Postgres with pgvector (Bitnami chart). Password will be autogenerated.
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: immich-db
  namespace: immich
spec:
  interval: 5m
  releaseName: immich-db
  chart:
    spec:
      chart: postgresql
      version: "16.*"
      sourceRef:
        kind: HelmRepository
        name: bitnami
        namespace: flux-system
      interval: 5m
  values:
    architecture: standalone
    image:
      repository: ghcr.io/immich-app/postgres
      tag: "17-vectorchord0.3.0-pgvectors0.3.0"
      pullPolicy: IfNotPresent
    auth:
      username: immich
      database: immich
    primary:
      initdb:
        scripts:
          00_extensions.sql: |
            CREATE EXTENSION IF NOT EXISTS pgvector;
    persistence:
      size: 10Gi
      storageClass: nfs
---
# Immich itself (Redis enabled; DB creds read from the PG Secret)
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: immich
  namespace: immich
spec:
  interval: 5m
  releaseName: immich
  dependsOn:
    - name: immich-db
      namespace: immich
  chart:
    spec:
      chart: immich
      version: "0.9.3"
      sourceRef:
        kind: HelmRepository
        name: immich
        namespace: flux-system
      interval: 5m
  values:
    image:
      tag: "v1.118.0"
    persistence:
      library:
        enabled: true
        existingClaim: immich-library
    redis:
      enabled: true
      auth:
        enabled: false
    env:
      DB_HOSTNAME: "immich-db-postgresql"
      DB_USERNAME: "immich"
      DB_DATABASE_NAME: "immich"
      DB_PASSWORD:
        valueFrom:
          secretKeyRef:
            name: immich-db-postgresql
            key: password
    server:
      ingress:
        enabled: true
        className: private
        hosts:
          - host: photos.hoam.lan
            paths:
              - path: /
                pathType: Prefix
        tls:
          - hosts: [photos.hoam.lan]
            secretName: photos-tls